# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# https://docs.travis-ci.com/user/ci-environment/
# trusty - 7.5GB memory and 2 cores
arch: ppc64le
os: linux
sudo: required
dist: trusty

# travis performs a shallow clone by default, in case of any issues
# that requires full git history, enable this
# before_install: git fetch --unshallow

language: java
jdk:
  - openjdk8
  - openjdk11

# disabling cache for /home/travis/.m2/repository/org/apache/hive/hive-jdbc/3.0.0-SNAPSHOT/hive-jdbc-3.0.0-SNAPSHOT-standalone.jar (Permission denied)
#cache:
#  directories:
#  - $HOME/.m2

env:
  MAVEN_SKIP_RC=true
  MAVEN_OPTS="-Xmx2g"

# workaround added: https://github.com/travis-ci/travis-ci/issues/4629
before_install:
  - sudo apt-get update -y
  - sudo apt-get install -y git tar make gcc g++ wget cmake libboost-all-dev bison flex openjdk-8-jdk maven gperf libsnappy-dev libevent-dev automake libtool libjson-perl libreadline-dev
  - sudo apt-get install -y libapr1 libapr1-dev unzip curl libcurl4-openssl-dev libbz2-dev pkg-config libssl-dev 
  - sudo apt-get install -y libjson* libxml2-dev python-dev python-setuptools python-pip libghc-gsasl-dev protobuf-compiler
  - sudo apt-get install -y libgtest-dev gsasl build-essential libkrb5-dev 
  - sudo apt-get install libyaml-dev libpython2.7-dev libgoogle-glog-dev libgflags-dev liblz4-dev libc6-dev  postgresql postgresql-contrib
  - sudo pip install pyyaml
  - sudo pip install cogapp
  - export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-ppc64el
  - export LD_LIBRARY_PATH=/usr/local/lib
  - sudo wget https://github.com/google/protobuf/releases/download/v2.5.0/protobuf-2.5.0.tar.gz
  - sudo tar -xvzf protobuf-2.5.0.tar.gz --no-same-owner
  - cd protobuf-2.5.0
  - ls -l
  - pwd
  - cat autogen.sh
  - sudo sed -i '22s/http:\/\/googletest.googlecode.com\/files\/gtest-1.5.0.tar.bz2/https:\/\/src.fedoraproject.org\/repo\/pkgs\/gtest\/gtest-1.5.0.tar.bz2\/8b2c3c3f26cb53e64a3109d03a97200a\/gtest-1.5.0.tar.bz2/' autogen.sh
  - ls
  - cd src/google/protobuf/stubs/
  - ls
  - sudo rm atomicops.h platform_macros.h
  - sudo wget https://raw.githubusercontent.com/protocolbuffers/protobuf/2.7.0/src/google/protobuf/stubs/atomicops.h
  - sudo wget https://raw.githubusercontent.com/protocolbuffers/protobuf/2.7.0/src/google/protobuf/stubs/atomicops_internals_power.h
  - sudo wget https://raw.githubusercontent.com/protocolbuffers/protobuf/2.7.0/src/google/protobuf/stubs/platform_macros.h
  - cd ../../../../
  - sudo ./autogen.sh
  - sudo ./configure
  - sudo make
  - sudo make install
  - protoc --version
  - sudo sed -i.bak -e 's|https://nexus.codehaus.org/snapshots/|https://oss.sonatype.org/content/repositories/codehaus-snapshots/|g' /etc/maven/settings.xml
  

install: true

script: 
  - mvn install:install-file -DgroupId=com.google.protobuf -DartifactId=protoc -Dversion=2.5.0 -Dclassifier=linux-ppcle_64 -Dpackaging=exe -Dfile=/usr/bin/protoc
  - sudo git clone https://github.com/apache/hive
  - cd hive
  - sudo mvn clean install -DskipTests=true -q -Pitests
